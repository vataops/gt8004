/**
 * HydroX Validator Deployment Script
 *
 * Computes Position and Vault validator addresses from plutus.json
 * and outputs the script addresses for .env configuration
 *
 * Run: node scripts/deploy-validators.mjs
 */

import { Lucid, Blockfrost } from "lucid-cardano";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment
const BLOCKFROST_KEY = process.env.BLOCKFROST_KEY || "previewxYyB0Uj87BX2fEUwMVgsMuq8OYdvaOFe";
const NETWORK = "Preview";

async function main() {
  console.log("=".repeat(60));
  console.log("HydroX Validator Deployment");
  console.log("=".repeat(60));
  console.log(`Network: ${NETWORK}`);
  console.log();

  // Load plutus.json from contracts directory
  const blueprintPath = path.join(__dirname, "../../contracts/aiken-vault/plutus.json");

  if (!fs.existsSync(blueprintPath)) {
    throw new Error(`Blueprint not found at ${blueprintPath}`);
  }

  const blueprint = JSON.parse(fs.readFileSync(blueprintPath, "utf-8"));

  console.log(`Loaded blueprint: ${blueprint.preamble.title} v${blueprint.preamble.version}`);
  console.log(`Plutus version: ${blueprint.preamble.plutusVersion}`);
  console.log();

  // Find validators
  const positionValidator = blueprint.validators.find(v => v.title === "position.position.spend");
  const vaultValidator = blueprint.validators.find(v => v.title === "vault.vault.spend");

  if (!positionValidator || !vaultValidator) {
    throw new Error("Could not find position or vault validator in blueprint");
  }

  console.log("Position validator hash (from blueprint):", positionValidator.hash);
  console.log("Vault validator hash (from blueprint):", vaultValidator.hash);
  console.log();

  // Initialize Lucid
  console.log("Connecting to Blockfrost...");
  const lucid = await Lucid.new(
    new Blockfrost(
      `https://cardano-preview.blockfrost.io/api/v0`,
      BLOCKFROST_KEY
    ),
    NETWORK
  );

  // Use the script hashes directly from the blueprint (computed by Aiken)
  // These are the canonical hashes for PlutusV3 validators
  const positionHash = positionValidator.hash;
  const vaultHash = vaultValidator.hash;

  // Derive addresses from script hashes using lucid's credential system
  // Script hash -> script credential -> address
  const positionAddress = lucid.utils.credentialToAddress({
    type: "Script",
    hash: positionHash,
  });

  const vaultAddress = lucid.utils.credentialToAddress({
    type: "Script",
    hash: vaultHash,
  });

  console.log();
  console.log("=".repeat(60));
  console.log("DEPLOYMENT RESULTS");
  console.log("=".repeat(60));
  console.log();
  console.log("Position Validator:");
  console.log(`  Hash: ${positionHash}`);
  console.log(`  Address: ${positionAddress}`);
  console.log();
  console.log("Vault Validator:");
  console.log(`  Hash: ${vaultHash}`);
  console.log(`  Address: ${vaultAddress}`);
  console.log();
  console.log("=".repeat(60));
  console.log("UPDATE YOUR .env FILE:");
  console.log("=".repeat(60));
  console.log();
  console.log(`POSITION_SCRIPT_ADDR=${positionAddress}`);
  console.log(`VAULT_SCRIPT_ADDR=${vaultAddress}`);
  console.log(`POSITION_SCRIPT_HASH=${positionHash}`);
  console.log(`VAULT_SCRIPT_HASH=${vaultHash}`);
  console.log();
  console.log("=".repeat(60));

  // Save to file in project root
  const envUpdate = `# Generated by deploy-validators.mjs at ${new Date().toISOString()}
# Updated Aiken validators with oracle price verification
POSITION_SCRIPT_ADDR=${positionAddress}
VAULT_SCRIPT_ADDR=${vaultAddress}
POSITION_SCRIPT_HASH=${positionHash}
VAULT_SCRIPT_HASH=${vaultHash}
`;

  const outputPath = path.join(__dirname, "../../.env.validators");
  fs.writeFileSync(outputPath, envUpdate.trim());
  console.log(`Saved to ${outputPath}`);
}

main().catch(console.error);
