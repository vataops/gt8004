upstream registry {
    server registry:8080;
}

upstream analytics {
    server analytics:8080;
}

upstream discovery {
    server discovery:8080;
}

upstream gateway_svc {
    server gateway:8080;
}

server {
    listen 80;

    # ── Analytics routes ──────────────────────────
    location /v1/ingest {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    location /v1/dashboard/ {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    location /v1/benchmark {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    # Agent sub-resources owned by Analytics
    location ~ ^/v1/agents/[^/]+/stats {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    location ~ ^/v1/agents/[^/]+/customers {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    location ~ ^/v1/agents/[^/]+/revenue {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    location ~ ^/v1/agents/[^/]+/performance {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    location ~ ^/v1/agents/[^/]+/logs {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
    location ~ ^/v1/agents/[^/]+/analytics {
        proxy_pass http://analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }

    # ── Discovery routes ──────────────────────────
    location /v1/network/ {
        proxy_pass http://discovery;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }

    # ── Gateway routes ────────────────────────────
    location /gateway/ {
        proxy_pass http://gateway_svc;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
        proxy_read_timeout 300s;
    }

    # ── Registry (default) ────────────────────────
    location / {
        proxy_pass http://registry;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Wallet-Address $http_x_wallet_address;
    }
}
